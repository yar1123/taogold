/*
Copyright 2011, KISSY UI Library v1.20dev
MIT Licensed
build time: Aug 25 16:19
*/
/**
 * @module  Attribute
 * @author  yiminghe@gmail.com, lifesinger@gmail.com
 */
KISSY.add('base/attribute', function(S, undef) {

    /**
     * 提供属性管理机制
     * @name Attribute
     * @class
     */
    function Attribute() {
        /**
         * attribute meta information
         {
         attrName: {
         getter: function,
         setter: function,
         value: v, // default value
         valueFn: function
         }
         }
         */
        this.__attrs = {};

        /**
         * attribute value
         {
         attrName: attrVal
         }
         */
        this.__attrVals = {};
    }

    S.augment(Attribute,
        /**
         * @lends Attribute.prototype
         */
        {

            __getDefAttrs: function() {
                return S.clone(this.__attrs);
            },

            /**
             * Adds an attribute with the provided configuration to the host object.
             * The config supports the following properties:
             * {
             *     value: 'the default value',
             *     valueFn: function
             *     setter: function
             *     getter: function
             * }
             * @param {boolean} override whether override existing attribute config ,default true
             */
            addAttr: function(name, attrConfig, override) {
                var host = this;
                if (!host.__attrs[name]) {
                    host.__attrs[name] = S.clone(attrConfig || {});
                } else {
                    S.mix(host.__attrs[name], attrConfig, override);
                }
                return host;
            },

            /**
             * Configures a group of attributes, and sets initial values.
             * @param {Object} attrConfigs  An object with attribute name/configuration pairs.
             * @param {Object} values An object with attribute name/value pairs, defining the initial values to apply.
             *        Values defined in the cfgs argument will be over-written by values in this argument.
             */
            addAttrs: function(attrConfigs, values) {
                var host = this;

                S.each(attrConfigs, function(attrConfig, name) {
                    if (name in values) {
                        attrConfig.value = values[name];
                    }
                    host.addAttr(name, attrConfig);
                });

                return host;
            },

            /**
             * Checks if the given attribute has been added to the host.
             */
            hasAttr: function(name) {
                return name && this.__attrs.hasOwnProperty(name);
            },

            /**
             * Removes an attribute from the host object.
             */
            removeAttr: function(name) {
                var host = this;

                if (host.hasAttr(name)) {
                    delete host.__attrs[name];
                    delete host.__attrVals[name];
                }

                return host;
            },

            /**
             * Sets the value of an attribute.
             */
            set: function(name, value) {
                var host = this,
                    prevVal = host.get(name);

                // if no change, just return
                if (prevVal === value) {
                    return;
                }

                // check before event
                if (false === host.__fireAttrChange('before', name, prevVal, value)) {
                    return;
                }

                // set it
                host.__set(name, value);

                // fire after event
                host.__fireAttrChange('after', name, prevVal, host.__attrVals[name]);

                return host;
            },

            __fireAttrChange: function(when, name, prevVal, newVal) {
                return this.fire(when + capitalFirst(name) + 'Change', {
                    attrName: name,
                    prevVal: prevVal,
                    newVal: newVal
                });
            },

            /**
             * internal use, no event involved, just set.
             * @private
             */
            __set: function(name, value) {
                var host = this,
                    setValue,
                    // if host does not have meta info corresponding to (name,value)
                    // then register on demand in order to collect all data meta info
                    // 一定要注册属性元数据，否则其他模块通过 _attrs 不能枚举到所有有效属性
                    // 因为属性在声明注册前可以直接设置值
                    attrConfig = host.__attrs[name] = host.__attrs[name] || {},
                    setter = attrConfig['setter'];

                // if setter has effect
                if (setter) {
                    setValue = setter.call(host, value);
                }
                if (setValue !== undef) {
                    value = setValue;
                }

                // finally set
                host.__attrVals[name] = value;
            },

            /**
             * Gets the current value of the attribute.
             */
            get: function(name) {
                var host = this, attrConfig, getter, ret;

                attrConfig = host.__attrs[name];
                getter = attrConfig && attrConfig['getter'];

                // get user-set value or default value
                //user-set value takes privilege
                ret = name in host.__attrVals ?
                    host.__attrVals[name] :
                    host.__getDefAttrVal(name);

                // invoke getter for this attribute
                if (getter) {
                    ret = getter.call(host, ret);
                }

                return ret;
            },

            __getDefAttrVal: function(name) {
                var host = this,
                    attrConfig = host.__attrs[name],
                    valFn, val;

                if (!attrConfig) {
                    return;
                }

                if ((valFn = attrConfig.valueFn)) {
                    val = valFn.call(host);
                    if (val !== undef) {
                        attrConfig.value = val;
                    }
                    delete attrConfig.valueFn;
                }

                return attrConfig.value;
            },

            /**
             * Resets the value of an attribute.just reset what addAttr set  (not what invoker set when call new Xx(cfg))
             * @param {String} name name of attribute
             */
            reset: function (name) {
                var host = this;

                if (host.hasAttr(name)) {
                    // if attribute does not have default value, then set to undefined.
                    return host.set(name, host.__getDefAttrVal(name));
                }

                // reset all
                for (name in host.__attrs) {
                    if (host.hasAttr(name)) {
                        host.reset(name);
                    }
                }

                return host;
            }
        });

    function capitalFirst(s) {
        s += '';
        return s.charAt(0).toUpperCase() + s.substring(1);
    }

    Attribute['__capitalFirst'] = capitalFirst;

    return Attribute;
});
/**
 * @module  Base
 * @author  yiminghe@gmail.com,lifesinger@gmail.com
 */
KISSY.add('base/base', function (S, Attribute, Event) {

    /**
     * Base for class-based component
     * @name Base
     * @extends Event.Target
     * @extends Attribute
     * @class
     */
    function Base(config) {
        Attribute.call(this);
        var c = this.constructor;

        // define
        while (c) {
            addAttrs(this, c['ATTRS']);
            c = c.superclass ? c.superclass.constructor : null;
        }
        // initial
        initAttrs(this, config);
    }

    function addAttrs(host, attrs) {
        if (attrs) {
            for (var attr in attrs) {
                // 子类上的 ATTRS 配置优先
                if (attrs.hasOwnProperty(attr)) {
                    //父类后加，父类不覆盖子类的相同设置
                    host.addAttr(attr, attrs[attr], false);
                }
            }
        }
    }

    function initAttrs(host, config) {
        if (config) {
            for (var attr in config) {
                if (config.hasOwnProperty(attr)) {
                    //用户设置会调用 setter 的，但不会触发属性变化事件
                    host.__set(attr, config[attr]);
                }

            }
        }
    }

    S.augment(Base, Event.Target, Attribute);
    return Base;
}, {
    requires:["./attribute","event"]
});
KISSY.add("base", function(S, Base) {
    return Base;
}, {
    requires:["base/base"]
});
