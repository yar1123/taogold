KISSY.config({packages:[{name:"taogold",path:"../assets/js/"}]});
KISSY.use("taogold/preview,taogold/dialog,taogold/coupleselect",function(j,w,s,u){function q(){var d={};if(e.get("#S_TemplateId"))d.tempid=e.get("#S_TemplateId").value;d.name=e.get("#S_TemplateName").value;d.position=e.get("#S_PositionTop").checked?"t":"b";d.mode=e.get("#S_SelectManual").checked?"m":"a";if(d.mode=="m")d.iid=e.get("#S_SelectItems").value;return d}function v(d){for(var a=true,b=["name","position","mode"],c=0;c<3;c++)if(d[b[c]]!=n[b[c]])a=false;if(d.mode=="m"&&n.mode=="m")if(d.iid!=
n.iid)a=false;return a}function k(){var d=e.get("#S_SavePreview"),a=q();d.disabled=a.mode=="m"&&a.iid.split(",").length<3?true:a.name==""?true:n.tempid&&v(a)?true:false}var e=j.DOM,f=j.Event,r=e.get("#S_SelectTrigger"),l,g,m,n=q();f.on("#S_TemplateName","keyup",function(){k()});f.on("#S_PositionTop","click",function(){k()});f.on("#S_PositionBottom","click",function(){k()});f.on("#S_SelectAuto","click",function(){k()});f.on("#S_SelectManual","click",function(){k()});f.on("#S_SelectManual","click",
function(){r.style.display=""});f.on("#S_SelectAuto","click",function(){r.style.display="none"});f.on(r,"click",function(){if(!l){l=new s({title:"\u95ab\u590b\u5ae8\u7039\u6fca\u7909",width:960});l.appendContent(e.create('<div class="couple-select"><div class="couple-select-src"><div class="bar">\u9351\u54c4\u656d\u6d93\ue160\u6b91\u7039\u6fca\u7909</div><div class="bar"><form class="form"><select id="S_ItemCat"><option value="">\u93b5\ufffd\u93c8\u590c\u88ab\u9429\ue1b9\ufffd\ufffd/option></select> <input id="S_ItemKw" type="text" /> <button id="S_ItemSchTrigger" class="button" type="button">\u93bc\u6ec5\u50a8</button></form></div><div id="S_CoupleSelectSrc" class="item-list"></div></div><div class="couple-select-target"><div class="bar">\u5bb8\u53c9\u5e39\u947d\u612e\u6b91\u7039\u6fca\u7909\u951b\u581c\u7af4\u934f\u535e\u5f72\u93ba\u3128\u5d183\u6d93\ue04e\u7d1a</div><div id="S_CoupleSelectTarget" class="item-list"></div><div class="bar"><form class="form"><button id="S_CoupleSelectSubmit" class="button finish-select" disabled="disabled" type="button">\u93b4\u6226\ufffd\u590a\u30bd\u6d5c\ufffd/button></form></div></div></div>'));
g=new u({src:"#S_CoupleSelectSrc",target:"#S_CoupleSelectTarget",itemCls:"item",itemTempl:'<div"><div class="img"><image src="{pic_url}"/></div><a class="title" iid="{num_iid}" href="http://item.taobao.com/item.htm?id={num_iid}" target="_blank">{title}</a><span class="price">\u951f\ue681price}</span><div class="operation"><a class="add" href="#">\u93ba\u3128\u5d18</a><a class="moveup" href="#">\u6d93\u5a44\u0429</a><a class="movedown" href="#">\u6d93\u5b2c\u0429</a><a class="remove" href="#">\u9352\u72bb\u6ace</a></div></div>'});g.on("add",function(){var a=g.getTargetItems();
if(a.length>3)for(var b=0,c=a.length;b<c-3;b++)g.remove(a[b])});var d=function(){e.get("#S_CoupleSelectSubmit").disabled=g.getTargetItems().length==3?false:true};g.on("add",function(){d()});g.on("remove",function(){d()});f.on("#S_CoupleSelectSrc","click",function(a){var b=a.target;if(e.hasClass(b,"add")){a.preventDefault();g.add(b)}});f.on("#S_CoupleSelectTarget","click",function(a){var b=a.target;if(e.hasClass(b,"moveup")){a.preventDefault();g.up(b)}else if(e.hasClass(b,"movedown")){a.preventDefault();
g.down(b)}else if(e.hasClass(b,"remove")){a.preventDefault();g.remove(b)}});m=function(){var a={start:-1,len:40,cat:"",kw:""},b=1;return function(c){c=c||{};j.mix(c,a,false);if(c.cat==a.cat&&c.kw==a.kw)if(b=="")return;else c.start=a.start+1;else c.start=0;j.io.get("onsales.html",c,function(h){h=eval(h);if(h.length!=0){for(var t=g.getTargetItems(),o=[],i=0,p=t.length;i<p;i++)o.push(e.get(".title",t[i]).getAttribute("iid"));o=o.toString();i=0;for(p=h.length;i<p;i++)if(o.indexOf(h[i].num_iid)>-1){h.splice(i,
1);i--;p--}c.cat==a.cat&&c.kw==a.kw?g.appendSrcItems(h):g.refreshSrcItems(h);a=c;b=h}})}}();m();(function(){var a=e.get("#S_CoupleSelectSrc"),b=true,c=0;f.on(a,"scroll",function(){if(b&&a.scrollHeight-a.offsetHeight-a.scrollTop<600&&a.scrollHeight>c){b=false;setTimeout(function(){b=true},3E3);c=a.scrollHeight;m()}})})();j.io.get("cats.html",null,function(a){a=eval(a);for(var b=j.get("#S_ItemCat"),c=0,h=a.length;c<h;c++)b.appendChild(e.create('<option value="'+a[c].cid+'">'+a[c].name+"</option>"));
b.value="";f.on(b,"change",function(){m({cat:b.value})})});f.on("#S_ItemSchTrigger","click",function(a){a.preventDefault();a={};a.kw=e.get("#S_ItemKw").value;m(a)});f.on("#S_CoupleSelectSubmit","click",function(){for(var a=g.getTargetItems(),b=[],c=0,h=a.length;c<h;c++)b.push(a[c]["data-item-info"].num_iid);e.get("#S_SelectItems").value=b.toString();l.hide();k()})}l.show()});f.on("#S_SavePreview","click",function(d){d.preventDefault();d=q();j.io.post("saveedit.html",d,function(a){a='<div class="msg"><div class="msg-default msg-tips"><i class="msg-icon"></i><div class="msg-content">\u59af\u2103\u6f98\u6dc7\u6fc6\u74e8\u93b4\u612c\u59db\u951b\u5c7c\u4e92\u6d93\u5b29\u8d1f\u68f0\u52ee\ue74d\u93c1\u581f\u7049\u9286\u509b\u504d\u9359\ue219\u4e92\u9358\ufffda href="rechome.html">\u59af\u2103\u6f98\u9352\u6944\u3003</a>\u6924\u7538\u6f70\u6769\u6d9c\ue511\u9429\u7a3f\u53e7\u93bf\u5d84\u7d94\u9286\ufffd/div></div></div>'+
a;var b=new s({title:"\u59af\u2103\u6f98\u68f0\u52ee\ue74d",width:770});b.on("hide",function(){window.location="rechome.html"});b.refreshContent(a);b.show()})})});
